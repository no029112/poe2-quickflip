<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PoE2 Quick-Flip Dashboard (Vanilla JS)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; background:#0b1220; color:#e5e7eb; }
    .container {  margin: 0 auto; padding: 24px; }
    .row { display:flex; flex-wrap: wrap; gap:12px; align-items: center; }
    .card { background: rgba(15,23,42,.6); border:1px solid rgba(71,85,105,.4); border-radius:16px; padding:16px; }
    label { font-size:12px; color:#94a3b8; display:block; margin-bottom:4px; }
    select,input,button { background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:8px; padding:8px; }
    button.primary { background:#059669; border-color:#10b981; }
    button.secondary { background:#111827; }
    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; background: rgba(15,23,42,.8); }
    th, td { padding:10px 12px; border-bottom:1px solid rgba(71,85,105,.35); }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,.35); }
    .buy { color:#34d399; }
    .sell { color:#fb7185; }
    .muted { color:#94a3b8; font-size: 12px; }
    .error { color:#fca5a5; }
    .ok { color:#34d399; }
    .warn { color:#f59e0b; }

    /* Highlights */
    .hl { background: rgba(16,185,129,0.18) !important; box-shadow: inset 0 0 0 1px rgba(16,185,129,0.40); }
    .hl-warn { background: rgba(234,179,8,0.16) !important; box-shadow: inset 0 0 0 1px rgba(234,179,8,0.35); }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; margin-left:6px; }
    .badge-go { background: rgba(16,185,129,0.25); border:1px solid rgba(16,185,129,0.5); }
    .badge-buy { background: rgba(234,179,8,0.25); border:1px solid rgba(234,179,8,0.5); }
    /* แถวที่เลือก */
    tr.selected { outline: 2px solid #60a5fa; background: rgba(59,130,246,0.14) !important; }

    /* Category picker (icons) */
    .cat-picker { position: relative; width: 320px; }
    .cat-current { display:flex; align-items:center; gap:8px; padding:8px 10px; background:#0f172a; border:1px solid #334155; border-radius:8px; cursor:pointer; }
    .cat-current img { width:22px; height:22px; border-radius:4px; object-fit: contain; }
    .cat-panel { position:absolute; top:110%; left:0; right:0; background:#0b1220; border:1px solid #334155; border-radius:10px; padding:8px; z-index:50; max-height:360px; overflow:auto; display:none; }
    .cat-panel.open { display:block; }
    .cat-section { font-size:11px; color:#94a3b8; padding:6px 8px; text-transform:uppercase; }
    .cat-item { display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; cursor:pointer; }
    .cat-item:hover { background:#111827; }
    .cat-item img { width:22px; height:22px; border-radius:4px; object-fit: contain; }
    .chip { display:inline-flex; gap:6px; align-items:center; background:#0f172a; border:1px solid #334155; border-radius:999px; padding:6px 10px; }
      /* ให้เห็นว่าเป็น tooltip */
    abbr[title]{
      text-decoration: underline dotted;
      text-underline-offset: 2px;
      cursor: help;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <h1 style="font-weight:700; font-size:22px">PoE2 Quick-Flip Dashboard</h1>
      <span class="muted">BUY ≤ P25; SELL ≥ max(P50, BUY×(1+TP)) — capped at P75. + B/S แนะนำ, ROI_net, BlockGap, Order Currency, Gold/1D</span>
    </div>

    <!-- Controls -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <!-- Category (icons) -->
        <div>
          <label>Category</label>
          <div class="cat-picker" id="catPicker">
            <div class="cat-current" id="catCurrent">
              <img id="catIcon" src="" alt="" />
              <span id="catLabel">ทั้งหมด (All)</span>
            </div>
            <div class="cat-panel" id="catPanel"></div>
          </div>
          <input type="hidden" id="category" value="all" />
        </div>

        <!-- Group toggles for All -->
        <div>
          <label>รวมกลุ่มเมื่อเลือก “All”</label>
          <div class="row">
            <label class="chip"><input type="checkbox" id="inclCurrency" checked /> Currency</label>
            <label class="chip"><input type="checkbox" id="inclUnique" checked /> Unique</label>
          </div>
        </div>

        <div>
          <label>League</label>
          <input id="league" value="Rise of the Abyssal" style="width:260px" />
        </div>
        <div>
          <label>Reference</label>
          <select id="ref">
            <option value="exalted">exalted</option>
            <option value="chaos">chaos</option>
            <option value="divine">divine</option>
          </select>
        </div>
        <div>
          <label>Per Page</label>
          <input type="number" id="perPage" value="25" style="width:100px" />
        </div>
        <div>
          <label>TP %</label>
          <input type="number" id="tpPct" value="3" style="width:100px" />
        </div>
        <div>
          <label>Min AvgQty</label>
          <input type="number" id="minAvgQty" value="300" style="width:100px" />
        </div>

        <!-- Highlights -->
        <div>
          <label>HL ROI ≥ %</label>
          <input type="number" id="hlRoi" value="12" style="width:100px" />
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:18px">
          <input type="checkbox" id="hlBuyZone" checked />
          <label for="hlBuyZone" style="margin:0">HL near BUY zone</label>
        </div>

        <!-- pcs/D filters -->
        <div>
          <label>Max S (pcs/D)</label>
          <input type="number" id="maxS" value="24" style="width:100px" />
        </div>
        <div>
          <label>Max B (pcs/D)</label>
          <input type="number" id="maxB" value="40" style="width:100px" />
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:18px">
          <input type="checkbox" id="hideNoBS" checked />
          <label for="hideNoBS" style="margin:0">ซ่อนรายการที่ยังคำนวณ B/S ไม่ได้</label>
        </div>

        <button class="primary" id="btnRefresh">Refresh</button>
        <button class="secondary" id="btnCsv">Download CSV</button>
      </div>
      <p id="error" class="error" style="margin-top:8px; display:none"></p>
    </div>

    <!-- Kulemak + Order Currency -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <div style="min-width:260px">
          <div class="muted">Kulemak Ratio (items / 1 Divine)</div>
          <div class="muted">Divine rate & ค่าธรรมเนียม ใช้คำนวณ B/S & ROI_net ในตาราง</div>
        </div>
        <div>
          <label>B (buy: pcs/Divine)</label>
          <input id="ratioB" type="number" value="20" style="width:110px" />
        </div>
        <div>
          <label>S (sell: pcs/Divine)</label>
          <input id="ratioS" type="number" value="16" style="width:110px" />
        </div>
        <div>
          <label>Fee buy %</label>
          <input id="feeBuy" type="number" value="1.0" style="width:100px" />
        </div>
        <div>
          <label>Fee sell %</label>
          <input id="feeSell" type="number" value="1.0" style="width:100px" />
        </div>
        <div class="row">
          <button id="btnAutoDiv" class="secondary">Auto 1D in <span id="refLabel">exalted</span></button>
          <input id="divineRate" type="number" step="0.001" placeholder="or enter 1 Divine in ref" style="width:200px" />
        </div>
      </div>

      <!-- Order currency settings -->
      <div class="row" style="margin-top:10px">
        <div>
          <label>Buy in (order currency)</label>
          <select id="buyCur">
            <option value="exalted">exalted</option>
            <option value="chaos">chaos</option>
            <option value="divine">divine</option>
          </select>
        </div>
        <div>
          <label>Sell in (order currency)</label>
          <select id="sellCur">
            <option value="divine">divine</option>
            <option value="exalted">exalted</option>
            <option value="chaos">chaos</option>
          </select>
        </div>
        <div>
          <label>Gold per unit (Ex/Chaos/Divine)</label>
          <div class="row">
            <input id="goldEx" type="number" value="120" style="width:90px" />
            <input id="goldChaos" type="number" value="160" style="width:90px" />
            <input id="goldDiv" type="number" value="800" style="width:90px" />
          </div>
        </div>
        <div>
          <label>Rates (per 1 Divine)</label>
          <div class="row">
            <button id="btnAutoRates" class="secondary">Auto Ex/Chaos per 1D</button>
            <button id="btnAutoRatesPH" class="secondary">Smart Auto Rates (PairHistory)</button>
            <input id="exPerDiv" type="number" step="0.001" placeholder="Ex/1D" style="width:120px" />
            <input id="chaosPerDiv" type="number" step="0.001" placeholder="Chaos/1D" style="width:120px" />
          </div>
        </div>
      </div>

      <div id="ratioOut" class="row" style="margin-top:12px"></div>
      <!-- Selected item summary (auto-populate when clicking a table row) -->
<div id="selWrap" class="row" style="margin-top:8px; display:none">
  <div class="card" style="flex:1">
    <div class="muted">Selected Item</div>
    <div id="selName" style="font-weight:700"></div>
    <div class="muted" id="selApi" style="margin-top:2px"></div>
    <div id="selStats" style="margin-top:8px"></div>
  </div>
</div>
      <div class="row"  style="margin-top:8px"> 
        <div id="orderCostOut1"  ></div>
        <div id="orderCostOut"  ></div>
      </div>
      
    </div>

    <!-- Table -->
    <div class="card" style="margin-top:12px">
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>Item</th><th>API ID</th><th>Last (Ex)</th>
              <th class="buy">BUY ≤ (Ex)</th><th class="sell">SELL ≥ (Ex)</th>
              <th>P10</th><th>P25</th><th>P50</th><th>P75</th><th>Avg Qty</th>
              <th>B (pcs/D)</th><th>S (pcs/D)</th><th>ROI_net %</th><th>BlockGap (B/S)</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="14" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ===== Category data (with icons) ===== */
    const CATS = {
      unique_categories: [
        // {"id":1,"apiId":"accessory","label":"Accessories","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvUmluZ3MvTWlycm9yUmluZyIsInciOjEsImgiOjEsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIiLCJkdXBsaWNhdGVkIjp0cnVlfV0/ec1c789fca/MirrorRing.png"},
        // {"id":2,"apiId":"armour","label":"Armour","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQXJtb3Vycy9IZWxtZXRzL1VuaXF1ZXMvQ3Jvd25PZlRoZVZpY3RvciIsInciOjIsImgiOjIsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/8397c94ec0/CrownOfTheVictor.png"},
        // {"id":4,"apiId":"flask","label":"Flasks","icon":"https://web.poecdn.com/gen/image/WzksMTQseyJmIjoiMkRJdGVtcy9GbGFza3MvVW5pcXVlcy9NZWx0aW5nTWFlbHN0cm9tIiwidyI6MSwiaCI6Miwic2NhbGUiOjEsInJlYWxtIjoicG9lMiIsImxldmVsIjoxfV0/3ffec91606/MeltingMaelstrom.png"},
        // {"id":6,"apiId":"jewel","label":"Jewels","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvSmV3ZWxzL0JyZWFjaEpld2VsIiwidyI6MSwiaCI6MSwic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/9c17747ff2/BreachJewel.png"},
        // {"id":7,"apiId":"map","label":"Maps","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvUXVlc3RJdGVtcy9QaW5uYWNsZUtleTEiLCJ3IjoxLCJoIjoxLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/0d3dddab3b/PinnacleKey1.png"},
        // {"id":8,"apiId":"weapon","label":"Weapons","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvV2VhcG9ucy9Ud29IYW5kV2VhcG9ucy9Ud29IYW5kTWFjZXMvVW5pcXVlcy9DaG9iZXJDaGFiZXIiLCJ3IjoyLCJoIjo0LCJzY2FsZSI6MSwicmVhbG0iOiJwb2VyIn1d/3de5003fa3/ChoberChaber.png"},
        // {"id":9,"apiId":"sanctum","label":"Sanctum Research","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvUmVsaWNzL1JlbGljVW5pcXVlM3gxIiwidyI6MywiaCI6MSwic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/0fd744ac28/RelicUnique3x1.png"}
      ],
      currency_categories: [
        {"id":1,"apiId":"currency","label":"Currency","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvQ3VycmVuY3lEdXBsaWNhdGUiLCJ3IjoxLCJoIjoxLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/b7f5cc7884/CurrencyDuplicate.png"},
        {"id":2,"apiId":"fragments","label":"Fragments","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvQnJlYWNoL0JyZWFjaHN0b25lU3BsaW50ZXIiLCJ3IjoxLCJoIjoxLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/00c84e43a8/BreachstoneSplinter.png"},
        {"id":3,"apiId":"runes","label":"Runes","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvUnVuZXMvQ29sZFJ1bmUiLCJ3IjoxLCJoIjoxLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/d3d9117ff2/ColdRune.png"},
        {"id":4,"apiId":"talismans","label":"Talismans","icon":"https://web.poecdn.com//gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvVG9ybWVudGVkU3Bpcml0U29ja2V0YWJsZXMvQXptZXJpU29ja2V0YWJsZU93bCIsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/dfe1212549/AzmeriSocketableOwl.png"},
        {"id":5,"apiId":"essences","label":"Essences","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvRXNzZW5jZS9BdHRyaWJ1dGVFc3NlbmNlIiwidyI6MSwiaCI6MSwic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/7ee5c92c60/AttributeEssence.png"},
        {"id":7,"apiId":"ultimatum","label":"Soul Cores","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvU291bENvcmVzL0dyZWF0ZXJTb3VsQ29yZUNyaXQiLCJ3IjoxLCJoIjoxLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/6d3a52eb08/GreaterSoulCoreCrit.png"},
        {"id":9,"apiId":"expedition","label":"Expedition Coinage & Artifacts","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvRXhwZWRpdGlvbi9CYXJ0ZXJSZWZyZXNoQ3VycmVuY3kiLCJ3IjoxLCJoIjoxLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/b0f42eaf8d/BarterRefreshCurrency.png"},
        {"id":10,"apiId":"ritual","label":"Ritual Omens","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvT21lbnMvVm9vZG9vT21lbnMxUmVkIiwidyI6MSwiaCI6MSwic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/1c90d2eb1f/VoodooOmens1Red.png"},
        {"id":13,"apiId":"vaultkeys","label":"Reliquary Keys","icon":"https://web.poecdn.com//gen/image/WzI4LDE0LHsiZiI6IjJESXRlbXMvTWFwcy9Ud2lsaWdodE9yZGVyUmVsaXF1YXJ5S2V5V29ybGQiLCJzY2FsZSI6MSwicmVhbG0iOiJwb2UyIn1d/11ce1d0bfd/TwilightOrderReliquaryKeyWorld.png"},
        {"id":15,"apiId":"breach","label":"Breach","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvQnJlYWNoL0JyZWFjaENhdGFseXN0RmlyZSIsInciOjEsImgiOjEsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/156de12dd6/BreachCatalystFire.png"},
        {"id":16,"apiId":"abyss","label":"Abyssal Bones","icon":"https://web.poecdn.com//gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvQWJ5c3MvUHJlc2VydmVkSmF3Ym9uZSIsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/2bb7939b21/PreservedJawbone.png"},
        {"id":17,"apiId":"uncutgems","label":"Uncut Gems","icon":"https://web.poecdn.com//gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvR2Vtcy9VbmN1dFNraWxsR2VtQnVmZiIsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/ab25e9aa3b/UncutSkillGemBuff.png"},
        {"id":18,"apiId":"lineagesupportgems","label":"Lineage Support Gems","icon":"https://web.poecdn.com//gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvR2Vtcy9OZXcvTmV3U3VwcG9ydC9MaW5lYWdlL0xpbmVhZ2VWaWxlbnRhIiwic2NhbGUiOjEsInJlYWxtIjoicG9lMiJ9XQ/abda900f3c/LineageVilenta.png"},
        {"id":11,"apiId":"delirium","label":"Delirium","icon":"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvRGlzdGlsbGVkRW1vdGlvbnMvRGlzdGlsbGVkRGVzcGFpciIsInciOjEsImgiOjEsInNjYWxlIjoxLCJyZWFsbSI6InBvZTIifV0/794fb40302/DistilledDespair.png"}
      ]
    };

    /* ===== Utils ===== */
    let selectedRowEl = null;

    const $ = (sel) => document.querySelector(sel);
    const fmt = (n,d=3)=> (n==null||Number.isNaN(n))? "-" : Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});
    function percentile(values,p){ if(!values||values.length===0) return null; const s=[...values].sort((a,b)=>a-b); if(s.length===1) return s[0]; const k=(s.length-1)*(p/100); const f=Math.floor(k),c=Math.ceil(k); if(f===c) return s[f]; return s[f]*(c-k)+s[c]*(k-f); }
    function csvEscape(s){ const t=String(s??""); return (t.includes(",")||t.includes("\n")||t.includes('"'))? '"'+t.replaceAll('"','""')+'"' : t; }

    const API_BASE = (location.hostname==="localhost"||location.hostname==="127.0.0.1")? "http://localhost:8787/api" : "https://poe2scout.com/api";
    // TODO: แก้ itemId ให้ถูกต้องตาม swagger ของคุณ
    const PAIR_IDS = {
      divine:  /* ใส่เลข itemId ของ Divine Orb */  291,
      exalted: /* ใส่เลข itemId ของ Exalted    */  290,
      chaos:   /* ใส่เลข itemId ของ Chaos      */  287,
    };
    async function fetchPairHistory(league, oneId, twoId, limit=300, endEpoch=null){
      const q = new URLSearchParams({
        league, currencyOneItemId: String(oneId), currencyTwoItemId: String(twoId), limit: String(limit)
      });
      if (endEpoch != null) q.set("endEpoch", String(endEpoch));
      const url = `${API_BASE}/currencyExchange/PairHistory?` + q.toString();
      const r = await fetch(url, { headers: {Accept:"application/json"} });
      if (!r.ok) throw new Error(r.status+" "+r.statusText);
      const data = await r.json();
      return (data && Array.isArray(data.History)) ? data.History : [];
    }

    // แปลง history -> อัตรา (two per one) แบบทน outlier + อิงปริมาณ
    function summarizePair(history){
      if (!history.length) return null;
      const rels = []; // เก็บ [price, weight]
      for (const h of history){
        const d = h?.Data;
        const a = Number(d?.CurrencyOneData?.RelativePrice);   // ราคาญาติจากฝั่ง one
        const b = Number(d?.CurrencyTwoData?.RelativePrice);   // ราคาญาติจากฝั่ง two
        const w = Number(d?.CurrencyOneData?.VolumeTraded || 0) + Number(d?.CurrencyTwoData?.VolumeTraded || 0);

        // เดา direction: ใช้ค่าที่สอดคล้องกันมากที่สุด
        // ถ้า a>0 และ b>0 มักเป็นผกผันกัน → ใช้ 1/b หรือ a ตาม sanity check
        let p = NaN;
        if (Number.isFinite(a) && a>0 && Number.isFinite(b) && b>0){
          const invB = 1/b;
          p = (Math.abs(a - invB) / Math.max(a, invB) < 0.15) ? (a+invB)/2 : a; // เผื่อกรณี noisy
        } else if (Number.isFinite(a) && a>0) p = a;
        else if (Number.isFinite(b) && b>0) p = 1/b;

        if (Number.isFinite(p) && p>0){
          // เก็บทั้งแบบน้ำหนักด้วย volume และแบบดิบไว้หาค่า robust
          rels.push([p, Math.max(w,1)]);
        }
      }
      if (!rels.length) return null;

      // Median ที่ถ่วงน้ำหนัก (approx)
      const xs = [];
      for (const [p,w] of rels) { const k = Math.max(1, Math.round(Math.log2(w+1))); for(let i=0;i<k;i++) xs.push(p); }
      xs.sort((x,y)=>x-y);
      const mid = xs[Math.floor(xs.length/2)];
      const p25 = xs[Math.floor(xs.length*0.25)];
      const p75 = xs[Math.floor(xs.length*0.75)];

      // VWAP อย่างง่าย (น้ำหนักด้วย volume)
      const sumW = rels.reduce((a,[,w])=>a+w,0);
      const vwap = rels.reduce((a,[p,w])=>a+p*w,0) / sumW;

      return { median: mid, p25, p75, vwap, samples: xs.length };
    }


    /* ===== Category picker with icons ===== */
    function buildCatPicker(){
      const panel=$("#catPanel"); panel.innerHTML="";
      const addItem=(label,icon,val)=>{ const div=document.createElement("div"); div.className="cat-item"; div.innerHTML=`<img src="${icon}" alt=""/><span>${label}</span>`; div.addEventListener("click",()=>selectCategory(val,label,icon)); panel.appendChild(div); };
      const allIcon="https://web.poecdn.com/gen/image/WzI1LDEzLCJ1aS9tb25vbGl0aC1jaGlwIl0/d6b6e9a8f7/monolith-chip.png";
      addItem("ทั้งหมด (All)",allIcon,"all");
      const s1=document.createElement("div"); s1.className="cat-section"; s1.textContent="Currency"; panel.appendChild(s1);
      CATS.currency_categories.forEach(c=> addItem(c.label,c.icon,`currency:${c.apiId}`));
      const s2=document.createElement("div"); s2.className="cat-section"; s2.textContent="Unique"; panel.appendChild(s2);
     // CATS.unique_categories.forEach(c=> addItem(c.label,c.icon,`unique:${c.apiId}`));
      $("#catCurrent").addEventListener("click",()=>$("#catPanel").classList.toggle("open"));
      document.addEventListener("click",(e)=>{ if(!$("#catPicker").contains(e.target)) $("#catPanel").classList.remove("open"); });
      selectCategory("all","ทั้งหมด (All)",allIcon,false);
    }
    function selectCategory(value,label,icon,doFetch=true){
      $("#category").value=value; $("#catLabel").textContent=label; $("#catIcon").src=icon||""; $("#catPanel").classList.remove("open");
      let target=300; if(value!=="all"){ const [g]=value.split(":"); target=(g==="unique")?50:300; }
      const cur=Number($("#minAvgQty").value||0); if([0,50,300,1000].includes(cur)) $("#minAvgQty").value=String(target);
      if(doFetch) fetchAllPages();
    }

    /* ===== State ===== */
    let items=[]; // aggregated items
    function getState(){
      return {
        catValue: $("#category").value,
        includeCurrency: $("#inclCurrency").checked,
        includeUnique: $("#inclUnique").checked,
        league: $("#league").value,
        ref: $("#ref").value,
        perPage: Number($("#perPage").value||25),
        tpPct: Number($("#tpPct").value||0),
        minAvgQty: Number($("#minAvgQty").value||0),
        feeBuy: Number($("#feeBuy").value||0)/100,
        feeSell: Number($("#feeSell").value||0)/100,
        divineRate: Number($("#divineRate").value)||null,
        // highlight & filters
        hlRoi: Number($("#hlRoi").value||0),
        hlBuyZone: $("#hlBuyZone").checked,
        maxS: Number($("#maxS").value||0),
        maxB: Number($("#maxB").value||0),
        hideNoBS: $("#hideNoBS").checked,
        // order currency + rates + gold
        buyCur: $("#buyCur").value,
        sellCur: $("#sellCur").value,
        exPerDiv: Number($("#exPerDiv").value)||null,
        chaosPerDiv: Number($("#chaosPerDiv").value)||null,
        goldEx: Number($("#goldEx").value||0),
        goldChaos: Number($("#goldChaos").value||0),
        goldDiv: Number($("#goldDiv").value||0),
      };
    }

    /* ===== Endpoint Resolution ===== */
    function categoryToEndpoints(s){
      const endpoints=[];
      const pushCurrency=(apiId)=>{ if(apiId==="ritual") endpoints.push("/items/currency/ritual","/items/omen/omen"); else endpoints.push(`/items/currency/${apiId}`); };
      const pushUnique=(apiId)=> endpoints.push(`/items/unique/${apiId}`);
      if(s.catValue==="all"){
        if(s.includeCurrency) CATS.currency_categories.forEach(c=>pushCurrency(c.apiId));
   //     if(s.includeUnique)   CATS.unique_categories.forEach(c=>pushUnique(c.apiId));
        return endpoints;
      }
      const [group,apiId]=s.catValue.split(":");
      if(group==="currency"){ pushCurrency(apiId); return endpoints; }
   //   if(group==="unique"){ pushUnique(apiId); return endpoints; }
      return ["/items/currency/currency"];
    }

    /* ===== Fetch ===== */
    async function fetchOneEndpoint(ep,s){
      let page=1; const out=[];
      while(true){
        const url=`${API_BASE}${ep}?referenceCurrency=${encodeURIComponent(s.ref)}&page=${page}&perPage=${s.perPage}&league=${encodeURIComponent(s.league)}`;
        const res=await fetch(url,{headers:{Accept:"application/json"}});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const data=await res.json(); const list=(data&&data.items)?data.items:[];
        out.push(...list); if(list.length < s.perPage) break; page++;
      }
      return out;
    }
    async function fetchAllPages(){
      const s=getState(); $("#error").style.display="none"; $("#tbody").innerHTML='<tr><td colspan="14" class="muted">Loading…</td></tr>';
      const endpoints=categoryToEndpoints(s); if(!endpoints.length){ $("#tbody").innerHTML='<tr><td colspan="14" class="muted">No category</td></tr>'; return; }
      const aggregated=[]; let any=false, lastErr=null;
      for(const ep of endpoints){
        try{ const part=await fetchOneEndpoint(ep,s); aggregated.push(...part); any=true; }catch(e){ lastErr=e; }
      }
      if(!any){ $("#error").textContent="Error: "+(lastErr?.message||lastErr||"fetch failed"); $("#error").style.display=""; $("#tbody").innerHTML='<tr><td colspan="14" class="muted">No data</td></tr>'; items=[]; return; }
      items=aggregated; render();
    }

    /* ===== Per-row metrics ===== */
    function computeBS(p25,p50,p75,tpPct,divineRate,fb,fs){
      if(!(divineRate>0) || p25==null || p50==null) return {B:null,S:null,ROI:null};
      const tp=(Math.max(0,Number(tpPct)||0))/100;
      const buyDiv=p25/divineRate;
      let sellRaw=Math.max(p50,p25*(1+tp)); if(p75!=null) sellRaw=Math.min(sellRaw,p75);
      const sellDiv=sellRaw/divineRate; if(!(buyDiv>0) || !(sellDiv>0)) return {B:null,S:null,ROI:null};
      const B=Math.max(1,Math.floor(1/buyDiv)); const S=Math.max(1,Math.ceil(1/sellDiv));
      const ROI=(B/S)*((1-fs)/(1+fb)) - 1; return {B,S,ROI};
    }
    function unitsPer1D(cur,s){ if(cur==="divine") return 1; if(cur==="exalted") return s.exPerDiv||null; if(cur==="chaos") return s.chaosPerDiv||null; return null; }
    function goldPer1D(cur,s){
      const units=unitsPer1D(cur,s); if(!(units>0)) return null;
      const gpUnit = cur==="divine" ? s.goldDiv : cur==="exalted" ? s.goldEx : s.goldChaos;
      return gpUnit*units;
    }

    function buildRows(){
      const s=getState(); const out=[];
      const defMin=(s.catValue==="all")?300: (s.catValue.startsWith("unique:")?50:300);
      const minQ=s.minAvgQty || defMin;

      for(const it of items){
        const name=(it && (it.text||it.apiId))||"-"; const apiId=it?.apiId; const current=it?.currentPrice ?? null;
        const logs=Array.isArray(it?.priceLogs)?it.priceLogs:[]; const prices=logs.map(p=>Number(p?.price)).filter(Number.isFinite);
        const qtys=logs.map(p=>Number(p?.quantity||0)).filter(Number.isFinite);
        if(!prices.length) continue;

        const p10=percentile(prices,10), p25=percentile(prices,25), p50=percentile(prices,50), p75=percentile(prices,75);
        const avgQty=qtys.length? qtys.reduce((a,b)=>a+b,0)/qtys.length : 0;
        if(avgQty < minQ) continue;

        const buy=p25 ?? null;
        let sell=null; if(buy!=null && p50!=null) sell=Math.max(p50, buy*(1 + s.tpPct/100)); else if(p50!=null) sell=p50; if(sell!=null && p75!=null) sell=Math.min(sell,p75);

        const {B,S,ROI}=computeBS(p25,p50,p75,s.tpPct,s.divineRate,s.feeBuy,s.feeSell);

        // filters pcs/D
        if(s.divineRate){
          if(s.hideNoBS && (B==null || S==null)) continue;
          if(s.maxS>0 && S!=null && S>s.maxS) continue;
          if(s.maxB>0 && B!=null && B>s.maxB) continue;
        }

        // BlockGap: ใช้แนวคิด approx จากฝั่งบทความ
        const bgB = (p10!=null && p25!=null && p25>0)? ((p25 - p10)/p25)*100 : null;            // ช่องว่างเหนือ aggressive-bid
        const bgS = (sell!=null && p50!=null && p50>0)? ((sell - p50)/p50)*100 : null;          // ช่องว่างต่ำกว่า median-ask ที่ต้องชนะ

        out.push({ name, apiId, current, buy, sell, p10, p25, p50, p75, avgQty, B, S, ROI, bgB, bgS });
      }

      out.sort((a,b)=>{ const r=((b.ROI??-1)-(a.ROI??-1)); if(r!==0) return r; return (Math.log10((b.avgQty||1)) - Math.log10((a.avgQty||1))); });
      return out;
    }
function showSelectedItem(o, tr){
  // ไฮไลต์แถวที่เลือก
  if (selectedRowEl) selectedRowEl.classList.remove("selected");
  selectedRowEl = tr; 
  if (selectedRowEl) selectedRowEl.classList.add("selected");

  // อัปเดตส่วนสรุป
  const s = getState();
  const needRate = !(s.divineRate > 0);
  const roiPct = (o.ROI!=null) ? (o.ROI*100).toFixed(2) + "%" : (needRate ? "— (set 1D rate)" : "-");

  const statsHtml = `
    <div>Last (Ex): <b>${fmt(o.current)}</b></div>
    <div>BUY ≤ (Ex): <b class="buy">${fmt(o.buy)}</b> | SELL ≥ (Ex): <b class="sell">${fmt(o.sell)}</b></div>
    <div>P25 / P50 / P75: <b>${fmt(o.p25)}</b> / <b>${fmt(o.p50)}</b> / <b>${fmt(o.p75)}</b></div>
    <div>Avg Qty: <b>${Math.round(o.avgQty).toLocaleString()}</b></div>
    <div style="margin-top:6px">Recommended B / S (pcs/D): 
      <b>${o.B ?? "-"}</b> / <b>${o.S ?? "-"}</b> 
      &nbsp;|&nbsp; ROI_net: <b>${roiPct}</b>
    </div>
    ${needRate ? '<div class="warn" style="margin-top:6px">กรุณากด “Auto 1D in [ref]” หรือใส่ Divine rate เพื่อคำนวณ B/S</div>' : ''}
  `;

  document.getElementById("selName").textContent = o.name || "-";
  document.getElementById("selApi").textContent  = o.apiId ? `API: ${o.apiId}` : "";
  document.getElementById("selStats").innerHTML  = statsHtml;
  document.getElementById("selWrap").style.display = "";

  // กรอก B/S เข้าช่อง Kulemak (ถ้ามี)
  if (o.B != null) document.getElementById("ratioB").value = String(o.B);
  if (o.S != null) document.getElementById("ratioS").value = String(o.S);

  // คำนวณพาเนล Kulemak ใหม่ด้วยค่า B/S ที่ตั้งให้
  computeRatio();
  // เลื่อน scroll ให้เห็นพาเนล (ถ้าอยาก)
  // document.getElementById("selWrap").scrollIntoView({ behavior:"smooth", block:"center" });
}

    function render(){
      const s=getState(); const rows=buildRows(); const tb=$("#tbody"); tb.innerHTML="";
      // Order currency summary
      const gBuy = goldPer1D(s.buyCur,s); const gSell= goldPer1D(s.sellCur,s);
      $("#orderCostOut").innerHTML = `
        <div class="card" style="flex:1">
          <div class="muted">Order currency (per 1 Divine notional)</div>
          <div>Buy in <b>${s.buyCur}</b> → Gold/1D: <b>${gBuy!=null? fmt(gBuy,0):'-'}</b></div>
          <div>Sell in <b>${s.sellCur}</b> → Gold/1D: <b>${gSell!=null? fmt(gSell,0):'-'}</b></div>
        </div>
      `;

      if(!rows.length){ tb.innerHTML='<tr><td colspan="14" class="muted">No data (check proxy or filters)</td></tr>'; return; }
      for(const o of rows){
        const roiOk=(s.divineRate!=null && o.ROI!=null && (o.ROI*100) >= s.hlRoi);
        const nearBuy=(s.hlBuyZone && o.current!=null && o.buy!=null && o.current <= (o.buy*1.01));

        const tr=document.createElement("tr");
        if(roiOk) tr.classList.add("hl"); else if(nearBuy) tr.classList.add("hl-warn");
        const badges=[ roiOk? `<span class="badge badge-go">ROI≥${(s.hlRoi|0)}%</span>`:"", nearBuy? '<span class="badge badge-buy">Near BUY</span>':"" ].filter(Boolean).join("");

        tr.innerHTML = `
          <td>${o.name} ${badges}</td>
          <td class="muted">${o.apiId ?? "-"}</td>
          <td>${fmt(o.current)}</td>
          <td class="buy">${fmt(o.buy)}</td>
          <td class="sell">${fmt(o.sell)}</td>
          <td>${fmt(o.p10)}</td>
          <td>${fmt(o.p25)}</td>
          <td>${fmt(o.p50)}</td>
          <td>${fmt(o.p75)}</td>
          <td>${Math.round(o.avgQty).toLocaleString()}</td>
          <td>${o.B ?? "-"}</td>
          <td>${o.S ?? "-"}</td>
          <td>${o.ROI!=null? fmt(o.ROI*100,2): "-"}</td>
          <td>${(o.bgB!=null? fmt(o.bgB,1):"-")} / ${ (o.bgS!=null? fmt(o.bgS,1):"-") }%</td>
        `;
        tr.addEventListener("click", () => showSelectedItem(o, tr));
        tb.appendChild(tr);
      }
    }

    /* ===== Kulemak panel (incl. order currency cost cards) ===== */
    const fmtNum=(n,d=4)=>fmt(n,d);
    function computeRatio(){
      const B=Math.max(0,Number($("#ratioB").value)||0);
      const S=Math.max(0,Number($("#ratioS").value)||0);
      const fb=Math.max(0,Number($("#feeBuy").value)||0)/100;
      const fs=Math.max(0,Number($("#feeSell").value)||0)/100;
      const rate=Number($("#divineRate").value)||null;
      if(!B||!S){ $("#ratioOut").innerHTML=""; return; }
      const buyDiv=1/B, sellDiv=1/S;
      const grossROI=(B/S)-1;
      const netROI=(B/S)*((1-fs)/(1+fb))-1;
      const profitPerDiv=(B/S)*(1-fs)-(1+fb);
      const Sbreak=B*(1-fs)/(1+fb);
      const go= S <= (Sbreak*0.99);
      const s=getState(); const buyRef=rate? buyDiv*rate : null; const sellRef=rate? sellDiv*rate : null;

      $("#ratioOut").innerHTML = `
        <div class="card" style="flex:1">
          <div class="muted">ราคาต่อชิ้น (Divine)</div>
          <div>BUY ≤ <span class="ok" style="font-weight:600">${fmtNum(buyDiv)} D</span></div>
          <div>SELL ≥ <span class="sell" style="font-weight:600">${fmtNum(sellDiv)} D</span></div>
          ${rate? `<div class="muted" style="margin-top:6px">เทียบ ${s.ref}: BUY ${fmt(buyRef)} / SELL ${fmt(sellRef)}</div>`:""}
        </div>
        <div class="card" style="flex:1">
          <div class="muted">ผลตอบแทน</div>
          <div>ROI (gross): <b>${fmt(grossROI*100,2)}%</b></div>
          <div>ROI (net): <b>${fmt(netROI*100,2)}%</b></div>
          <div>กำไร/เงินลง (ต่อ 1 D): <b>${fmt(profitPerDiv,4)} D</b></div>
        </div>
        <div class="card" style="flex:1">
          <div class="muted">ความเสี่ยง & จุดคุ้มทุน</div>
          <div>Break-even S ≤ <b>${fmt(Sbreak,2)}</b> pcs/D</div>
          <div class="${go?'ok':'warn'}" style="margin-top:6px; font-weight:700">${go? 'GO (ผ่าน buffer 1%)':'WAIT (ใกล้เส้นคุ้มทุน)'}</div>
        </div>
      `;
    }

    /* ===== Auto Divine & Auto Rates ===== */
    async function autoDivine(){
      const s=getState(); $("#refLabel").textContent=s.ref; $("#error").style.display="none";
      try{
        let page=1, found=null;
        while(page<=3 && !found){
          const url=`${API_BASE}/items/currency/currency?referenceCurrency=${encodeURIComponent(s.ref)}&page=${page}&perPage=25&league=${encodeURIComponent(s.league)}`;
          const r=await fetch(url,{headers:{Accept:"application/json"}}); if(!r.ok) throw new Error(r.status+" "+r.statusText);
          const data=await r.json(); const items=(data&&data.items)?data.items:[];
          for(const it of items){ const id=(it.apiId||"").toLowerCase(); const name=(it.text||"").toLowerCase(); if(id.includes("divine")||name.includes("divine orb")){ found=Number(it.currentPrice); break; } }
          if(items.length<25) break; page++;
        }
        if(found){ $("#divineRate").value=String(found); computeRatio(); render(); }
        else throw new Error("ไม่พบราคา Divine ในหน้าแรก");
      }catch(e){ $("#error").textContent="Auto Divine failed: "+(e.message||e); $("#error").style.display=""; }
    }
    async function autoRates(){
      const s=getState(); $("#error").style.display="none";
      try{
        // fetch Ex/1D
        const exP = fetch(`${API_BASE}/items/currency/currency?referenceCurrency=exalted&page=1&perPage=25&league=${encodeURIComponent(s.league)}`,{headers:{Accept:"application/json"}})
          .then(r=>{ if(!r.ok) throw new Error("exalted "+r.status); return r.json(); })
          .then(d=> (d.items||[]).find(it=> (it.apiId||"").toLowerCase().includes("divine") || (it.text||"").toLowerCase().includes("divine orb"))?.currentPrice || null);
        // fetch Chaos/1D
        const chP = fetch(`${API_BASE}/items/currency/currency?referenceCurrency=chaos&page=1&perPage=25&league=${encodeURIComponent(s.league)}`,{headers:{Accept:"application/json"}})
          .then(r=>{ if(!r.ok) throw new Error("chaos "+r.status); return r.json(); })
          .then(d=> (d.items||[]).find(it=> (it.apiId||"").toLowerCase().includes("divine") || (it.text||"").toLowerCase().includes("divine orb"))?.currentPrice || null);

        const [exPerDiv, chaosPerDiv] = await Promise.all([exP, chP]);
        if(exPerDiv) $("#exPerDiv").value = String(exPerDiv);
        if(chaosPerDiv) $("#chaosPerDiv").value = String(chaosPerDiv);
        render();
      }catch(e){ $("#error").textContent="Auto rates failed: "+(e.message||e); $("#error").style.display=""; }
    }


    async function autoRatesFromPairHistory(){
  const s = getState();
  try{
    // Divine→Exalted
    const hx = await fetchPairHistory(s.league, PAIR_IDS.divine, PAIR_IDS.exalted, 10, null);
    const sx = summarizePair(hx); // ได้ "Ex per 1 Divine" ที่ robust
    // Divine→Chaos
    const hc = await fetchPairHistory(s.league, PAIR_IDS.divine, PAIR_IDS.chaos, 10, null);
    const sc = summarizePair(hc); // ได้ "Chaos per 1 Divine"

    if (sx?.median) document.getElementById("exPerDiv").value = sx.median.toFixed(3);
    if (sc?.median) document.getElementById("chaosPerDiv").value = sc.median.toFixed(3);


    $("#orderCostOut1").innerHTML  = `
      <div class="card" style="flex:1">
        <div class="muted">PairHistory snapshot</div>
        <div>Ex/1D ~ median ${sx? sx.median.toFixed(3): "-"} (IQR ${sx? (sx.p25.toFixed(3)+"–"+sx.p75.toFixed(3)):"-"})</div>
        <div>Chaos/1D ~ median ${sc? sc.median.toFixed(3): "-"} (IQR ${sc? (sc.p25.toFixed(3)+"–"+sc.p75.toFixed(3)):"-"})</div>
      </div>`;
    box.insertAdjacentHTML("afterbegin", note);
    
    render();
    // โชว์โน้ตสั้น ๆ
    
  }catch(e){
    const err = document.getElementById("error");
    err.textContent = "PairHistory failed: " + (e.message||e);
    err.style.display = "";
  }
}
    
    /* ===== Events ===== */
    document.getElementById("btnAutoRatesPH").addEventListener("click", autoRatesFromPairHistory);
    $("#btnRefresh").addEventListener("click", fetchAllPages);
    $("#btnCsv").addEventListener("click", ()=>{ const rows=buildRows(); if(!rows.length) return; const headers=["Item","API ID","Last (Ex)","BUY ≤ (Ex)","SELL ≥ (Ex)","P10","P25","P50","P75","Avg Qty","B (pcs/D)","S (pcs/D)","ROI_net %","BlockGapB %","BlockGapS %"]; const body=rows.map(o=>[o.name,o.apiId,o.current,o.buy,o.sell,o.p10,o.p25,o.p50,o.p75,Math.round(o.avgQty),o.B,o.S,(o.ROI!=null?(o.ROI*100).toFixed(2):""),(o.bgB!=null?o.bgB.toFixed(1):""),(o.bgS!=null?o.bgS.toFixed(1):"")]); const csv=[headers.map(csvEscape).join(","), ...body.map(r=>r.map(csvEscape).join(","))].join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="poe2_quickflip.csv"; a.click(); URL.revokeObjectURL(url); });

    $("#btnAutoDiv").addEventListener("click", autoDivine);
    $("#btnAutoRates").addEventListener("click", autoRates);

    ["ratioB","ratioS","feeBuy","feeSell","divineRate","ref"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{ computeRatio(); render(); });
    });
    ["league","ref","perPage","tpPct","minAvgQty","hlRoi","hlBuyZone","maxS","maxB","hideNoBS","inclCurrency","inclUnique","buyCur","sellCur","goldEx","goldChaos","goldDiv","exPerDiv","chaosPerDiv"]
      .forEach(id=>{
        const el=document.getElementById(id);
        el.addEventListener("change", ()=>{ computeRatio(); render(); });
        el.addEventListener("input",  ()=>{ computeRatio(); render(); });
      });
    function applyTooltips(){
  // 2.1 หัวตาราง (ระบุตาม index ของ <th>)
  const thTips = {
    0: "ชื่อไอเทม",
    1: "รหัส API ของไอเทม",
    2: "ราคาล่าสุดในหน่วย Exalted ที่ API รายงาน (currentPrice)",
    3: "เพดานราคาซื้อแนะนำ (Ex): ใช้ P25 เป็นหลัก",
    4: "พื้นราคาขายแนะนำ (Ex): max(P50, BUY×(1+TP%)) แต่ไม่เกิน P75",
    5: "P10: 10th percentile ของราคาย้อนหลัง (ใช้แทน aggressive bid)",
    6: "P25: 25th percentile (ใช้เป็นเพดาน BUY)",
    7: "P50: 50th percentile/Median (ฐาน SELL)",
    8: "P75: 75th percentile (เพดาน SELL)",
    9: "Avg Qty: ปริมาณเฉลี่ยต่อ snapshot ใน priceLogs (ตัวชี้วัดสภาพคล่อง)",
    10:"B (pcs/D): จำนวนชิ้นต่อ 1 Divine ที่ซื้อได้ที่ราคา BUY (floor)",
    11:"S (pcs/D): จำนวนชิ้นต่อ 1 Divine ที่ต้องขายที่ราคา SELL เพื่อรับ 1D คืน (ceil)",
    12:"ROI_net %: (B/S)×((1−feeSell)/(1+feeBuy)) − 1 หลังค่าธรรมเนียม",
    13:"BlockGap (B/S): B = (P25−P10)/P25, S = (SELL−P50)/P50 — ค่าต่ำ=ยืนชิดบล็อกใหญ่"
  };
  const ths = document.querySelectorAll('#tbl thead th');
  ths.forEach((th, i) => {
    const tip = thTips[i];
    if (!tip) return;
    if (th.dataset.tipped) return;
    const text = th.textContent;
    th.innerHTML = `<abbr title="${tip.replace(/"/g,'&quot;')}">${text}</abbr>`;
    th.dataset.tipped = '1';
  });

  // 2.2 ใส่ tooltip ให้ labels/ปุ่ม ในแผงควบคุม
  const L = (id, tip) => {
    const el = document.getElementById(id);
    if (!el) return;
    // ปกติ label อยู่ใน parent เดียวกันและอยู่ก่อน input
    let lab = el.parentElement && el.parentElement.querySelector('label');
    // สำหรับ checkbox ที่มี label[for] อยู่ถัดไป
    if (!lab) lab = document.querySelector(`label[for="${id}"]`);
    if (lab) lab.title = tip;
  };
  const B = (id, tip) => { const el = document.getElementById(id); if (el) el.title = tip; };

  // Controls (ด้านบน)
  L('league',      'ชื่อลีกที่จะดึงข้อมูลจาก API');
  L('ref',         'หน่วยอ้างอิงสำหรับดึง/เทียบราคา (exalted/chaos/divine)');
  L('perPage',     'จำนวนรายการต่อหนึ่งหน้าที่เรียกจาก API (ต่อ endpoint)');
  L('tpPct',       'Target Profit %: เพิ่มจาก BUY เพื่อกำหนด SELL ขั้นต่ำ (cap ด้วย P75)');
  L('minAvgQty',   'คัดรายการที่สภาพคล่องต่ำกว่าค่านี้ออก (เฉลี่ยปริมาณต่อ snapshot)');
  L('hlRoi',       'ไฮไลต์แถวที่ ROI_net ≥ ค่านี้');
  L('hlBuyZone',   'ไฮไลต์แถวที่ราคาปัจจุบัน ≤ BUY×1.01 (อยู่โซนซื้อ)');
  L('maxS',        'ตัดรายการที่ S (pcs/D) สูงกว่าเกณฑ์นี้ (ขายย่อยเกินไป)');
  L('maxB',        'ตัดรายการที่ B (pcs/D) สูงกว่าเกณฑ์นี้ (ซื้อย่อยเกินไป)');
  L('hideNoBS',    'ซ่อนรายการที่ยังไม่สามารถคำนวณ B/S ได้ (ยังไม่มี Divine rate/P25/P50)');

  // Kulemak Ratio
  L('ratioB',      'จำนวนชิ้นที่ “ตั้งใจซื้อได้” ต่อ 1 Divine ในแผนของคุณ');
  L('ratioS',      'จำนวนชิ้นที่ “ต้องขาย” ต่อ 1 Divine เพื่อคืนทุน/ทำกำไร');
  L('feeBuy',      'ค่าธรรมเนียม/ภาษีฝั่งซื้อ (%)');
  L('feeSell',     'ค่าธรรมเนียมฝั่งขาย (%)');
  L('divineRate',  '1 Divine เท่ากับกี่หน่วยในสกุลอ้างอิง (ใช้คำนวณทุกแถวในตาราง)');
  B('btnAutoDiv',  'ดึงราคา 1 Divine ในสกุลอ้างอิง (Ref) อัตโนมัติจาก API');

  // Order Currency & Gold/1D
  L('buyCur',      'สกุลที่ใช้ตั้งคำสั่ง “ซื้อ” (กระทบต้นทุน Gold/1D)');
  L('sellCur',     'สกุลที่ใช้ตั้งคำสั่ง “ขาย”');
  L('goldEx',      'ต้นทุนทองต่อ 1 Exalted (ปรับได้)');
  L('goldChaos',   'ต้นทุนทองต่อ 1 Chaos (ปรับได้)');
  L('goldDiv',     'ต้นทุนทองต่อ 1 Divine (ปรับได้)');
  L('exPerDiv',    'จำนวน Exalted ต่อ 1 Divine (Ex/1D)');
  L('chaosPerDiv', 'จำนวน Chaos ต่อ 1 Divine (Chaos/1D)');
  B('btnAutoRates','ดึง Ex/1D และ Chaos/1D อัตโนมัติจาก API');

  // Toggles เมื่อเลือก All
  const inclCurrency = document.getElementById('inclCurrency');
  const inclUnique   = document.getElementById('inclUnique');
  if (inclCurrency && inclCurrency.parentElement) inclCurrency.parentElement.title = 'รวมหมวดฝั่ง Currency ทั้งหมดเมื่อเลือก “All”';
  if (inclUnique   && inclUnique.parentElement)   inclUnique.parentElement.title   = 'รวมหมวดฝั่ง Unique ทั้งหมดเมื่อเลือก “All”';
}
    document.addEventListener("DOMContentLoaded", ()=>{ 
      buildCatPicker(); 
     // fetchAllPages(); 
      computeRatio(); 
      applyTooltips();
    });

    
  </script>
</body>
</html>
